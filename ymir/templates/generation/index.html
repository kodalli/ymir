<div class="w-full">
    <!-- Header -->
    <div class="mb-4 pb-4 border-b border-theme">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold tracking-tight">Agent Generation Wizard</h1>
                <p class="text-theme-secondary text-sm">Create multi-turn agent training data in 4 simple steps</p>
            </div>
            <span id="generate-spinner" class="htmx-indicator flex items-center gap-2 px-4 py-2 bg-surface-sidebar rounded-lg text-theme-secondary text-sm border border-theme">
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-ymir-500"></i>
                Processing...
            </span>
        </div>
    </div>

    <!-- Stepper -->
    <div id="wizard-stepper" class="mb-4">
        {% with step=1 %}
        {% include "generation/wizard/stepper.html" %}
        {% endwith %}
    </div>

    <!-- Wizard Form -->
    <form id="wizard-form" class="space-y-6">
        <!-- Hidden fields for wizard state -->
        <input type="hidden" id="wizard-scenario-id" name="scenario_id" value="{{ default_scenario.id if default_scenario else '' }}">
        <input type="hidden" id="wizard-enabled-tools" name="enabled_tools" value="[]">
        <input type="hidden" id="wizard-mode" name="mode_toggle" value="single">
        <input type="hidden" id="wizard-user-query" name="user_query" value="">
        <input type="hidden" id="wizard-user-situation" name="user_situation" value="">
        <input type="hidden" id="wizard-user-background" name="user_background" value="">
        <input type="hidden" id="wizard-user-goal" name="user_goal" value="">
        <input type="hidden" id="wizard-current-step" value="1">

        <!-- Step Content -->
        <div id="wizard-step-content" class="card p-8 min-h-[500px]">
            {% with step=1, scenario=default_scenario %}
            {% include "generation/wizard/step_scenario.html" %}
            {% endwith %}
        </div>

        <!-- Navigation Buttons -->
        <div id="wizard-nav" class="flex items-center justify-between">
            <button type="button" id="wizard-back"
                class="btn-secondary flex items-center gap-2 px-6 py-3 invisible"
                _="on click call goToPrevStep()">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Back</span>
            </button>

            <div class="flex items-center gap-2 text-sm text-theme-muted">
                <span id="step-indicator">Step 1 of 4</span>
            </div>

            <button type="button" id="wizard-next"
                class="btn-primary flex items-center gap-2 px-6 py-3"
                _="on click call goToNextStep()">
                <span>Next</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
    </form>
</div>

<script>
// Use window namespace to avoid re-declaration errors on HTMX navigation
window.wizardState = window.wizardState || {
    currentStep: 1,
    totalSteps: 4,
    STORAGE_KEY: 'ymir_wizard_state'
};
var wizard = window.wizardState;

// Reset step to 1 for fresh page load (localStorage will override if state exists)
wizard.currentStep = 1;

// State persistence functions
function saveWizardState() {
    var state = {
        currentStep: wizard.currentStep,
        scenarioId: document.getElementById('wizard-scenario-id').value,
        enabledTools: document.getElementById('wizard-enabled-tools').value,
        mode: document.getElementById('wizard-mode').value,
        userQuery: document.getElementById('wizard-user-query').value,
        userSituation: document.getElementById('wizard-user-situation').value,
        userBackground: document.getElementById('wizard-user-background').value,
        userGoal: document.getElementById('wizard-user-goal').value,
    };
    localStorage.setItem(wizard.STORAGE_KEY, JSON.stringify(state));
}

function loadWizardState() {
    var saved = localStorage.getItem(wizard.STORAGE_KEY);
    if (!saved) return false;

    try {
        var state = JSON.parse(saved);
        document.getElementById('wizard-scenario-id').value = state.scenarioId || '';
        document.getElementById('wizard-enabled-tools').value = state.enabledTools || '[]';
        document.getElementById('wizard-mode').value = state.mode || 'single';
        document.getElementById('wizard-user-query').value = state.userQuery || '';
        document.getElementById('wizard-user-situation').value = state.userSituation || '';
        document.getElementById('wizard-user-background').value = state.userBackground || '';
        document.getElementById('wizard-user-goal').value = state.userGoal || '';
        wizard.currentStep = state.currentStep || 1;
        return true;
    } catch (e) {
        return false;
    }
}

function clearWizardState() {
    localStorage.removeItem(wizard.STORAGE_KEY);
}

// Initialize wizard
function initWizard() {
    var hasState = loadWizardState();

    if (hasState && wizard.currentStep > 1) {
        loadStep(wizard.currentStep);
    } else {
        updateNavButtons();
        initializeToolsList();
    }

    lucide.createIcons();
}

// Run initialization
initWizard();

function initializeToolsList() {
    var scenarioId = document.getElementById('wizard-scenario-id').value;
    if (scenarioId) {
        var toolCheckboxes = document.querySelectorAll('input[data-tool-name]');
        var enabledTools = [];
        toolCheckboxes.forEach(function(cb) {
            if (cb.checked) {
                enabledTools.push(cb.dataset.toolName);
            }
        });
        if (enabledTools.length > 0) {
            document.getElementById('wizard-enabled-tools').value = JSON.stringify(enabledTools);
        }
    }
}

function goToNextStep() {
    if (wizard.currentStep >= wizard.totalSteps) return;

    syncFormValues();
    if (!validateStep(wizard.currentStep)) return;

    wizard.currentStep++;
    loadStep(wizard.currentStep);
}

function goToPrevStep() {
    if (wizard.currentStep <= 1) return;

    syncFormValues();
    wizard.currentStep--;
    loadStep(wizard.currentStep);
}

function goToStep(step) {
    if (step < 1 || step > wizard.totalSteps) return;
    if (step > wizard.currentStep) {
        for (var s = wizard.currentStep; s < step; s++) {
            if (!validateStep(s)) return;
        }
    }

    syncFormValues();
    wizard.currentStep = step;
    loadStep(wizard.currentStep);
}

function syncFormValues() {
    var modeRadio = document.querySelector('input[name="mode_toggle"]:checked');
    if (modeRadio) {
        document.getElementById('wizard-mode').value = modeRadio.value;
    }

    var queryInput = document.querySelector('textarea[name="user_query_input"]');
    if (queryInput) {
        document.getElementById('wizard-user-query').value = queryInput.value;
    }

    var sitInput = document.querySelector('textarea[name="user_situation_input"]');
    if (sitInput) {
        document.getElementById('wizard-user-situation').value = sitInput.value;
    }

    var bgInput = document.querySelector('textarea[name="user_background_input"]');
    if (bgInput) {
        document.getElementById('wizard-user-background').value = bgInput.value;
    }

    var goalInput = document.querySelector('textarea[name="user_goal_input"]');
    if (goalInput) {
        document.getElementById('wizard-user-goal').value = goalInput.value;
    }

    var toolCheckboxes = document.querySelectorAll('input[data-tool-name]');
    if (toolCheckboxes.length > 0) {
        var enabledTools = [];
        toolCheckboxes.forEach(function(cb) {
            if (cb.checked) {
                enabledTools.push(cb.dataset.toolName);
            }
        });
        document.getElementById('wizard-enabled-tools').value = JSON.stringify(enabledTools);
    }

    saveWizardState();
}

function validateStep(step) {
    switch (step) {
        case 1:
            var scenarioId = document.getElementById('wizard-scenario-id').value;
            if (!scenarioId) {
                showToast('Please select a scenario', 'error');
                return false;
            }
            return true;
        case 2:
            var enabledTools = document.getElementById('wizard-enabled-tools').value;
            try {
                var tools = JSON.parse(enabledTools);
                if (tools.length === 0) {
                    showToast('Please enable at least one tool', 'error');
                    return false;
                }
            } catch (e) {}
            return true;
        case 3:
            var mode = document.getElementById('wizard-mode').value;
            if (mode === 'single') {
                var query = document.getElementById('wizard-user-query').value;
                if (!query.trim()) {
                    showToast('Please enter a query', 'error');
                    return false;
                }
            } else {
                var sit = document.getElementById('wizard-user-situation').value;
                var goal = document.getElementById('wizard-user-goal').value;
                if (!sit.trim()) {
                    showToast('Please fill in the situation details', 'error');
                    return false;
                }
                if (!goal.trim()) {
                    showToast('Please fill in the actor goal', 'error');
                    return false;
                }
            }
            return true;
        default:
            return true;
    }
}

function loadStep(step) {
    var scenarioId = document.getElementById('wizard-scenario-id').value;
    var url = '/generation/step/' + step + '?scenario_id=' + encodeURIComponent(scenarioId);

    htmx.ajax('GET', url, {
        target: '#wizard-step-content',
        swap: 'innerHTML'
    }).then(function() {
        updateNavButtons();
        updateStepper();
        document.getElementById('wizard-current-step').value = step;
        restoreFormValues(step);
    });
}

function restoreFormValues(step) {
    setTimeout(function() {
        if (step === 2) {
            var enabledTools = document.getElementById('wizard-enabled-tools').value;
            try {
                var tools = JSON.parse(enabledTools);
                document.querySelectorAll('input[data-tool-name]').forEach(function(cb) {
                    cb.checked = tools.includes(cb.dataset.toolName);
                });
                updateToolCount();
            } catch (e) {}
        }

        if (step === 3) {
            var mode = document.getElementById('wizard-mode').value;
            var modeRadio = document.querySelector('input[name="mode_toggle"][value="' + mode + '"]');
            if (modeRadio) {
                modeRadio.checked = true;
                modeRadio.dispatchEvent(new Event('change'));
            }

            var query = document.getElementById('wizard-user-query').value;
            var queryInput = document.querySelector('textarea[name="user_query_input"]');
            if (queryInput) queryInput.value = query;

            var sit = document.getElementById('wizard-user-situation').value;
            var bg = document.getElementById('wizard-user-background').value;
            var goal = document.getElementById('wizard-user-goal').value;
            var sitInput = document.querySelector('textarea[name="user_situation_input"]');
            var bgInput = document.querySelector('textarea[name="user_background_input"]');
            var goalInput = document.querySelector('textarea[name="user_goal_input"]');
            if (sitInput) sitInput.value = sit;
            if (bgInput) bgInput.value = bg;
            if (goalInput) goalInput.value = goal;
        }

        if (step === 4) {
            updateGenerateSummary();
        }

        lucide.createIcons();
    }, 100);
}

function updateToolCount() {
    var checkboxes = document.querySelectorAll('input[data-tool-name]');
    var total = checkboxes.length;
    var enabled = Array.from(checkboxes).filter(function(cb) { return cb.checked; }).length;
    var counter = document.getElementById('tool-count');
    if (counter) {
        counter.textContent = enabled + ' of ' + total + ' tools enabled';
    }
}

function updateNavButtons() {
    var backBtn = document.getElementById('wizard-back');
    var nextBtn = document.getElementById('wizard-next');
    var stepIndicator = document.getElementById('step-indicator');

    if (wizard.currentStep === 1) {
        backBtn.classList.add('invisible');
    } else {
        backBtn.classList.remove('invisible');
    }

    if (wizard.currentStep === wizard.totalSteps) {
        nextBtn.classList.add('hidden');
    } else {
        nextBtn.classList.remove('hidden');
        nextBtn.innerHTML = '<span>Next</span><i data-lucide="arrow-right" class="w-4 h-4"></i>';
    }

    stepIndicator.textContent = 'Step ' + wizard.currentStep + ' of ' + wizard.totalSteps;
    lucide.createIcons();
}

function updateStepper() {
    htmx.ajax('GET', '/generation/stepper/' + wizard.currentStep, {
        target: '#wizard-stepper',
        swap: 'innerHTML'
    }).then(function() {
        lucide.createIcons();
    });
}

function updateGenerateSummary() {
    var scenarioId = document.getElementById('wizard-scenario-id').value;
    var enabledTools = document.getElementById('wizard-enabled-tools').value;
    var mode = document.getElementById('wizard-mode').value;

    var scenarioEl = document.getElementById('summary-scenario');
    var toolsEl = document.getElementById('summary-tools');
    var modeEl = document.getElementById('summary-mode');

    if (scenarioEl) {
        scenarioEl.textContent = scenarioId || 'Not selected';
    }

    if (toolsEl) {
        try {
            var tools = JSON.parse(enabledTools);
            toolsEl.textContent = tools.length + ' tool' + (tools.length !== 1 ? 's' : '') + ' enabled';
        } catch (e) {
            toolsEl.textContent = 'All enabled';
        }
    }

    if (modeEl) {
        modeEl.textContent = mode === 'simulated' ? 'Simulated Actor' : 'Single Query';
    }
}

function showToast(message, type) {
    type = type || 'info';
    var toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 animate-in slide-in-from-right ' +
        (type === 'error' ? 'bg-error-500/90 text-white' : 'bg-surface-sidebar text-white border border-theme');
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(function() {
        toast.remove();
    }, 3000);
}
</script>
