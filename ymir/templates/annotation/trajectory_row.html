<!-- Data Row -->
<tr class="trajectory-row hover:bg-slate-800/30 transition-colors cursor-pointer"
    id="row-{{ item.trajectory.id }}"
    data-trajectory-id="{{ item.trajectory.id }}"
    _="on click if event.target.type !== 'checkbox'
       toggle .hidden on #detail-{{ item.trajectory.id }}
       if #detail-{{ item.trajectory.id }} matches .hidden
           remove .expanded from me
       else
           add .expanded to me
       end">

    <!-- Checkbox -->
    <td class="p-4" _="on click halt">
        <input type="checkbox" class="row-checkbox w-4 h-4 rounded border-slate-600 bg-slate-800 text-ymir-500"
            value="{{ item.trajectory.id }}"
            _="on change call updateBulkActions()">
    </td>

    <!-- ID -->
    <td class="p-4">
        <span class="font-mono text-sm text-slate-400">{{ item.trajectory.id[:8] }}...</span>
    </td>

    <!-- Scenario -->
    <td class="p-4">
        <div class="max-w-[200px]">
            <div class="font-medium text-sm text-slate-200 truncate">
                {{ item.trajectory.scenario_description[:40] }}{% if item.trajectory.scenario_description|length > 40 %}...{% endif %}
            </div>
            {% if item.trajectory.scenario_id %}
            <div class="text-xs text-slate-500 font-mono truncate">{{ item.trajectory.scenario_id }}</div>
            {% endif %}
        </div>
    </td>

    <!-- Turns -->
    <td class="p-4 text-center">
        <span class="inline-flex items-center justify-center w-8 h-8 bg-slate-800 rounded-lg text-sm font-bold text-slate-300">
            {{ item.trajectory.messages|length }}
        </span>
    </td>

    <!-- Quality Score -->
    <td class="p-4 text-center">
        {% if item.trajectory.quality_score is not none %}
        <div class="inline-flex flex-col items-center">
            <span class="text-lg font-black {% if item.trajectory.quality_score >= 0.7 %}text-green-500{% elif item.trajectory.quality_score >= 0.5 %}text-yellow-500{% else %}text-red-500{% endif %}">
                {{ "%.2f"|format(item.trajectory.quality_score) }}
            </span>
            <div class="h-1 w-12 bg-slate-800 rounded-full overflow-hidden mt-1">
                <div class="h-full {% if item.trajectory.quality_score >= 0.7 %}bg-green-500{% elif item.trajectory.quality_score >= 0.5 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                    style="width: {{ item.trajectory.quality_score * 100 }}%"></div>
            </div>
        </div>
        {% else %}
        <span class="text-slate-600">--</span>
        {% endif %}
    </td>

    <!-- Status Badge -->
    <td class="p-4 text-center">
        {% set traj_status = item.trajectory.status.value %}
        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold uppercase tracking-wide
            {% if traj_status == 'approved' %}bg-green-500/10 text-green-500 border border-green-500/20
            {% elif traj_status == 'rejected' %}bg-red-500/10 text-red-500 border border-red-500/20
            {% elif traj_status == 'needs_edit' %}bg-blue-500/10 text-blue-500 border border-blue-500/20
            {% else %}bg-yellow-500/10 text-yellow-500 border border-yellow-500/20{% endif %}">
            {% if traj_status == 'approved' %}<i data-lucide="check" class="w-3 h-3"></i>
            {% elif traj_status == 'rejected' %}<i data-lucide="x" class="w-3 h-3"></i>
            {% elif traj_status == 'needs_edit' %}<i data-lucide="edit-2" class="w-3 h-3"></i>
            {% else %}<i data-lucide="clock" class="w-3 h-3"></i>{% endif %}
            {{ traj_status | replace('_', ' ') }}
        </span>
    </td>

    <!-- Issues -->
    <td class="p-4 text-center">
        <div class="flex items-center justify-center gap-1">
            {% set issue_types = item.issues | map(attribute='type') | map(attribute='value') | list %}
            {% if 'hallucination' in issue_types %}
            <span class="w-6 h-6 rounded-full bg-red-500/10 flex items-center justify-center" title="Hallucination detected">
                <i data-lucide="alert-circle" class="w-3.5 h-3.5 text-red-500"></i>
            </span>
            {% endif %}
            {% if 'goal_drift' in issue_types %}
            <span class="w-6 h-6 rounded-full bg-orange-500/10 flex items-center justify-center" title="Goal drift detected">
                <i data-lucide="compass" class="w-3.5 h-3.5 text-orange-500"></i>
            </span>
            {% endif %}
            {% if 'tool_skipping' in issue_types %}
            <span class="w-6 h-6 rounded-full bg-yellow-500/10 flex items-center justify-center" title="Tool skipping detected">
                <i data-lucide="skip-forward" class="w-3.5 h-3.5 text-yellow-500"></i>
            </span>
            {% endif %}
            {% if 'suspicious_pattern' in issue_types %}
            <span class="w-6 h-6 rounded-full bg-purple-500/10 flex items-center justify-center" title="Suspicious pattern detected">
                <i data-lucide="shield-alert" class="w-3.5 h-3.5 text-purple-500"></i>
            </span>
            {% endif %}
            {% if not item.issues %}
            <span class="text-green-500"><i data-lucide="check-circle" class="w-4 h-4"></i></span>
            {% endif %}
        </div>
    </td>

    <!-- Created Date -->
    <td class="p-4">
        <span class="text-sm text-slate-400">
            {{ item.trajectory.created_at.strftime('%Y-%m-%d') }}
        </span>
        <div class="text-xs text-slate-600">
            {{ item.trajectory.created_at.strftime('%H:%M') }}
        </div>
    </td>
</tr>

<!-- Expandable Detail Row -->
<tr id="detail-{{ item.trajectory.id }}" class="hidden bg-slate-900/50">
    <td colspan="8" class="p-0">
        <div hx-get="/annotation/trajectory/{{ item.trajectory.id }}/expand"
            hx-trigger="intersect once"
            hx-swap="innerHTML"
            class="p-6">
            <div class="flex items-center justify-center py-4">
                <div class="animate-spin w-5 h-5 border-2 border-ymir-500 border-t-transparent rounded-full"></div>
            </div>
        </div>
    </td>
</tr>
