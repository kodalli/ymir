<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8 pb-6 border-b border-theme">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Agent Generation Wizard</h1>
                <p class="text-theme-secondary mt-1">Create multi-turn agent training data in 4 simple steps</p>
            </div>
            <span id="generate-spinner" class="htmx-indicator flex items-center gap-2 px-4 py-2 bg-surface-sidebar rounded-lg text-theme-secondary text-sm border border-theme">
                <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-ymir-500"></i>
                Processing...
            </span>
        </div>
    </div>

    <!-- Stepper -->
    <div id="wizard-stepper" class="mb-8">
        {% with step=1 %}
        {% include "generation/wizard/stepper.html" %}
        {% endwith %}
    </div>

    <!-- Wizard Form -->
    <form id="wizard-form" class="space-y-6">
        <!-- Hidden fields for wizard state -->
        <input type="hidden" id="wizard-scenario-id" name="scenario_id" value="{{ default_scenario.id if default_scenario else '' }}">
        <input type="hidden" id="wizard-enabled-tools" name="enabled_tools" value="[]">
        <input type="hidden" id="wizard-mode" name="mode_toggle" value="single">
        <input type="hidden" id="wizard-user-query" name="user_query" value="">
        <input type="hidden" id="wizard-user-situation" name="user_situation" value="">
        <input type="hidden" id="wizard-user-background" name="user_background" value="">
        <input type="hidden" id="wizard-user-goal" name="user_goal" value="">
        <input type="hidden" id="wizard-current-step" value="1">

        <!-- Step Content -->
        <div id="wizard-step-content" class="card p-8 min-h-[500px]">
            {% with step=1, scenario=default_scenario %}
            {% include "generation/wizard/step_scenario.html" %}
            {% endwith %}
        </div>

        <!-- Navigation Buttons -->
        <div id="wizard-nav" class="flex items-center justify-between">
            <button type="button" id="wizard-back"
                class="btn-secondary flex items-center gap-2 px-6 py-3 invisible"
                _="on click call goToPrevStep()">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                <span>Back</span>
            </button>

            <div class="flex items-center gap-2 text-sm text-theme-muted">
                <span id="step-indicator">Step 1 of 4</span>
            </div>

            <button type="button" id="wizard-next"
                class="btn-primary flex items-center gap-2 px-6 py-3"
                _="on click call goToNextStep()">
                <span>Next</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
    </form>
</div>

<script>
// Wizard state
let currentStep = 1;
const totalSteps = 4;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateNavButtons();
    initializeToolsList();
    lucide.createIcons();
});

// Re-initialize icons after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(e) {
    lucide.createIcons();
    if (e.detail.target.id === 'wizard-step-content') {
        // Re-initialize any step-specific behavior
        if (currentStep === 2) {
            initializeToolsList();
        }
    }
});

function initializeToolsList() {
    // Initialize enabled tools with all tools from current scenario
    const scenarioId = document.getElementById('wizard-scenario-id').value;
    if (scenarioId) {
        const toolCheckboxes = document.querySelectorAll('input[data-tool-name]');
        const enabledTools = [];
        toolCheckboxes.forEach(cb => {
            if (cb.checked) {
                enabledTools.push(cb.dataset.toolName);
            }
        });
        if (enabledTools.length > 0) {
            document.getElementById('wizard-enabled-tools').value = JSON.stringify(enabledTools);
        }
    }
}

function goToNextStep() {
    if (currentStep >= totalSteps) return;

    // Validate current step
    if (!validateStep(currentStep)) return;

    // Sync form values before navigation
    syncFormValues();

    currentStep++;
    loadStep(currentStep);
}

function goToPrevStep() {
    if (currentStep <= 1) return;

    // Sync form values before navigation
    syncFormValues();

    currentStep--;
    loadStep(currentStep);
}

function goToStep(step) {
    if (step < 1 || step > totalSteps) return;
    if (step > currentStep) {
        // Can only go forward if current step is valid
        for (let s = currentStep; s < step; s++) {
            if (!validateStep(s)) return;
        }
    }

    syncFormValues();
    currentStep = step;
    loadStep(currentStep);
}

function syncFormValues() {
    // Sync any visible input values to hidden fields

    // Sync mode toggle
    const modeRadio = document.querySelector('input[name="mode_toggle"]:checked');
    if (modeRadio) {
        document.getElementById('wizard-mode').value = modeRadio.value;
    }

    // Sync user query
    const queryInput = document.querySelector('textarea[name="user_query_input"]');
    if (queryInput) {
        document.getElementById('wizard-user-query').value = queryInput.value;
    }

    // Sync situation
    const sitInput = document.querySelector('textarea[name="user_situation_input"]');
    if (sitInput) {
        document.getElementById('wizard-user-situation').value = sitInput.value;
    }

    // Sync background
    const bgInput = document.querySelector('textarea[name="user_background_input"]');
    if (bgInput) {
        document.getElementById('wizard-user-background').value = bgInput.value;
    }

    // Sync goal
    const goalInput = document.querySelector('textarea[name="user_goal_input"]');
    if (goalInput) {
        document.getElementById('wizard-user-goal').value = goalInput.value;
    }

    // Sync enabled tools
    const toolCheckboxes = document.querySelectorAll('input[data-tool-name]');
    if (toolCheckboxes.length > 0) {
        const enabledTools = [];
        toolCheckboxes.forEach(cb => {
            if (cb.checked) {
                enabledTools.push(cb.dataset.toolName);
            }
        });
        document.getElementById('wizard-enabled-tools').value = JSON.stringify(enabledTools);
    }
}

function validateStep(step) {
    switch (step) {
        case 1:
            const scenarioId = document.getElementById('wizard-scenario-id').value;
            if (!scenarioId) {
                showToast('Please select a scenario', 'error');
                return false;
            }
            return true;
        case 2:
            const enabledTools = document.getElementById('wizard-enabled-tools').value;
            try {
                const tools = JSON.parse(enabledTools);
                if (tools.length === 0) {
                    showToast('Please enable at least one tool', 'error');
                    return false;
                }
            } catch (e) {
                // No tools parsed, might be initial state
            }
            return true;
        case 3:
            const mode = document.getElementById('wizard-mode').value;
            if (mode === 'single') {
                const query = document.getElementById('wizard-user-query').value;
                if (!query.trim()) {
                    showToast('Please enter a query', 'error');
                    return false;
                }
            } else {
                const sit = document.getElementById('wizard-user-situation').value;
                const goal = document.getElementById('wizard-user-goal').value;
                if (!sit.trim()) {
                    showToast('Please fill in the situation details', 'error');
                    return false;
                }
                if (!goal.trim()) {
                    showToast('Please fill in the actor goal', 'error');
                    return false;
                }
            }
            return true;
        default:
            return true;
    }
}

function loadStep(step) {
    const scenarioId = document.getElementById('wizard-scenario-id').value;
    const url = `/generation/step/${step}?scenario_id=${encodeURIComponent(scenarioId)}`;

    htmx.ajax('GET', url, {
        target: '#wizard-step-content',
        swap: 'innerHTML'
    }).then(() => {
        updateNavButtons();
        updateStepper();
        document.getElementById('wizard-current-step').value = step;

        // Restore form values for the step
        restoreFormValues(step);
    });
}

function restoreFormValues(step) {
    setTimeout(() => {
        if (step === 2) {
            // Restore tool selections
            const enabledTools = document.getElementById('wizard-enabled-tools').value;
            try {
                const tools = JSON.parse(enabledTools);
                document.querySelectorAll('input[data-tool-name]').forEach(cb => {
                    cb.checked = tools.includes(cb.dataset.toolName);
                });
                updateToolCount();
            } catch (e) {}
        }

        if (step === 3) {
            // Restore mode selection
            const mode = document.getElementById('wizard-mode').value;
            const modeRadio = document.querySelector(`input[name="mode_toggle"][value="${mode}"]`);
            if (modeRadio) {
                modeRadio.checked = true;
                modeRadio.dispatchEvent(new Event('change'));
            }

            // Restore query
            const query = document.getElementById('wizard-user-query').value;
            const queryInput = document.querySelector('textarea[name="user_query_input"]');
            if (queryInput) queryInput.value = query;

            // Restore situation/background/goal
            const sit = document.getElementById('wizard-user-situation').value;
            const bg = document.getElementById('wizard-user-background').value;
            const goal = document.getElementById('wizard-user-goal').value;
            const sitInput = document.querySelector('textarea[name="user_situation_input"]');
            const bgInput = document.querySelector('textarea[name="user_background_input"]');
            const goalInput = document.querySelector('textarea[name="user_goal_input"]');
            if (sitInput) sitInput.value = sit;
            if (bgInput) bgInput.value = bg;
            if (goalInput) goalInput.value = goal;

        }

        if (step === 4) {
            // Update summary display
            updateGenerateSummary();

            // Restore model/temperature
            const model = document.getElementById('wizard-model');
            const temp = document.getElementById('wizard-temperature');
            // These keep their values from the form
        }

        lucide.createIcons();
    }, 100);
}

function updateToolCount() {
    const checkboxes = document.querySelectorAll('input[data-tool-name]');
    const total = checkboxes.length;
    const enabled = Array.from(checkboxes).filter(cb => cb.checked).length;
    const counter = document.getElementById('tool-count');
    if (counter) {
        counter.textContent = `${enabled} of ${total} tools enabled`;
    }
}

function updateNavButtons() {
    const backBtn = document.getElementById('wizard-back');
    const nextBtn = document.getElementById('wizard-next');
    const stepIndicator = document.getElementById('step-indicator');

    // Show/hide back button
    if (currentStep === 1) {
        backBtn.classList.add('invisible');
    } else {
        backBtn.classList.remove('invisible');
    }

    // Change next button text on last step
    if (currentStep === totalSteps) {
        nextBtn.classList.add('hidden');
    } else {
        nextBtn.classList.remove('hidden');
        nextBtn.innerHTML = `<span>Next</span><i data-lucide="arrow-right" class="w-4 h-4"></i>`;
    }

    // Update step indicator
    stepIndicator.textContent = `Step ${currentStep} of ${totalSteps}`;

    lucide.createIcons();
}

function updateStepper() {
    // Fetch the stepper template with the current step
    htmx.ajax('GET', `/generation/stepper/${currentStep}`, {
        target: '#wizard-stepper',
        swap: 'innerHTML'
    }).then(() => {
        lucide.createIcons();
    });
}

function updateGenerateSummary() {
    const scenarioId = document.getElementById('wizard-scenario-id').value;
    const enabledTools = document.getElementById('wizard-enabled-tools').value;
    const mode = document.getElementById('wizard-mode').value;

    const scenarioEl = document.getElementById('summary-scenario');
    const toolsEl = document.getElementById('summary-tools');
    const modeEl = document.getElementById('summary-mode');

    if (scenarioEl) {
        scenarioEl.textContent = scenarioId || 'Not selected';
    }

    if (toolsEl) {
        try {
            const tools = JSON.parse(enabledTools);
            toolsEl.textContent = `${tools.length} tool${tools.length !== 1 ? 's' : ''} enabled`;
        } catch (e) {
            toolsEl.textContent = 'All enabled';
        }
    }

    if (modeEl) {
        modeEl.textContent = mode === 'simulated' ? 'Simulated Actor' : 'Single Query';
    }
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 animate-in slide-in-from-right ${
        type === 'error' ? 'bg-error-500/90 text-white' : 'bg-surface-sidebar text-white border border-theme'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Listen for step navigation from stepper clicks
document.addEventListener('stepNavigate', function(e) {
    goToStep(e.detail.step);
});
</script>
